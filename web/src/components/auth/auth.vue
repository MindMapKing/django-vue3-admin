<!--
====================================================================================================
                                     权限控制组件 (auth.vue)
====================================================================================================

【文件功能概述】
这是一个基于Vue 3 + TypeScript + Pinia的细粒度权限控制组件，主要功能包括：

1. 【权限验证】：根据用户的按钮权限列表验证当前操作权限
2. 【条件渲染】：只有拥有权限的用户才能看到被包裹的组件内容
3. 【插槽机制】：通过slot机制包裹需要权限控制的任意组件
4. 【响应式权限】：与Pinia状态管理深度集成，权限变化时自动更新UI

【使用场景】
- 按钮级别的权限控制：<auth value="user:add"><el-button>添加用户</el-button></auth>
- 菜单项权限控制：<auth value="menu:system"><menu-item>系统管理</menu-item></auth>
- 功能模块权限控制：<auth value="module:report"><report-component /></auth>

【权限系统架构】
State（状态）：存储用户权限数据，包括authBtnList按钮权限列表
Actions（方法）：提供权限数据的增删改查操作，如setUserInfos、updateUserInfos等
Getters（计算）：提供权限验证的计算逻辑，如getUserAuthBtnList权限检查

【技术特点】
- 使用Vue 3 Composition API的script setup语法糖
- TypeScript提供完整的类型安全
- Pinia状态管理确保权限数据的响应式更新
- 计算属性自动缓存，性能优化
====================================================================================================
-->

<template>
	<!-- 
		权限渲染模板：使用Vue的条件渲染指令
		v-if="getUserAuthBtnList" 当权限验证通过时才渲染插槽内容
		<slot />: Vue插槽，允许父组件传入任意内容进行权限包裹
		
		工作流程：
		1. 组件接收value属性（权限标识符）
		2. getUserAuthBtnList计算属性验证权限
		3. 验证通过则显示slot内容，否则不渲染任何内容
	-->
	<slot v-if="getUserAuthBtnList" />
</template>

<script setup lang="ts" name="auth">
/**
 * ====================================================================================================
 *                                    权限控制组件核心逻辑
 * ====================================================================================================
 * 
 * 【组件设计模式】
 * - 高阶组件模式：包装其他组件，提供权限控制能力
 * - 声明式权限：通过value属性声明所需权限，无需手动编写权限判断逻辑
 * - 组合式API：使用Vue 3最新的Composition API，代码更清晰、可复用性更强
 * 
 * 【script setup 语法糖优势解析】
 * 1. 编译时优化：Vue编译器会对setup语法糖进行特殊优化，生成更高效的代码
 * 2. 类型推断增强：TypeScript能够更好地推断变量类型，减少手动类型声明
 * 3. 自动暴露机制：顶层声明的变量、函数自动暴露给模板，无需手动return
 * 4. 代码简洁性：相比传统Options API，代码量减少约40%
 * 5. 逻辑复用：更容易抽取为composable函数，提高代码复用性
 */

// ===================================== 依赖导入区域 =====================================

// Vue 3 响应式API导入：computed用于创建计算属性
import { computed } from 'vue';

// Pinia状态管理工具导入：storeToRefs用于保持store数据的响应式特性
// 注意：直接解构store会失去响应性，必须使用storeToRefs包装
import { storeToRefs } from 'pinia';

// 用户信息状态管理模块导入：提供用户权限数据和相关操作方法
import { useUserInfo } from '/@/stores/userInfo';

// ===================================== 组件属性定义 =====================================

/**
 * Props定义：接收父组件传递的权限配置
 * 
 * 【设计思想】
 * - 单一职责：只接收权限标识符，保持组件功能专一
 * - 类型安全：使用TypeScript严格类型定义，避免运行时错误
 * - 默认值处理：提供合理的默认值，增强组件健壮性
 */
const props = defineProps({
	value: {
		type: String,                    // 权限标识符，对应后端权限系统中的权限码
		default: () => '',               // 默认为空字符串，防止undefined错误
		// 示例值：'user:add', 'role:edit', 'system:config'
	},
});

// ===================================== 状态管理集成 =====================================

/**
 * Pinia Store集成：获取用户权限数据
 * 
 * 【State的作用】
 * State是Pinia中的状态数据，类似于Vuex的state，用于存储应用的全局状态：
 * 1. 数据存储：保存用户信息、权限列表、登录状态等
 * 2. 响应式：基于Vue的响应式系统，数据变化时自动更新相关组件
 * 3. 持久化：可配合本地存储，实现数据持久化
 * 4. 类型安全：TypeScript提供完整的类型检查
 * 
 * 在用户权限系统中，State主要存储：
 * - userInfos.authBtnList: 用户拥有的按钮权限列表
 * - userInfos.roles: 用户角色信息
 * - userInfos.username: 用户基本信息
 */
const stores = useUserInfo();           // 获取用户信息store实例，包含所有用户相关的状态和方法

/**
 * 响应式数据解构：提取用户信息数据
 * 
 * 【storeToRefs的重要性】
 * - 保持响应性：确保解构出的数据仍然具有Vue的响应式特性
 * - 避免失效：直接解构store会导致响应式失效，数据更新时组件不会重新渲染
 * - 性能优化：只监听实际使用的数据，提高性能
 */
const { userInfos } = storeToRefs(stores);

// ===================================== 权限验证逻辑 =====================================

/**
 * 权限检查计算属性：核心权限验证逻辑
 * 
 * 【Actions的作用】
 * Actions是Pinia中的操作方法，类似于Vuex的actions，用于处理业务逻辑：
 * 1. 异步操作：处理API调用、数据获取等异步任务
 * 2. 状态修改：修改state中的数据（虽然在Pinia中也可以直接修改state）
 * 3. 业务逻辑：包含复杂的业务处理逻辑
 * 4. 副作用处理：处理本地存储、路由跳转等副作用
 * 
 * 在用户权限系统中，Actions主要包括：
 * - setUserInfos(): 设置用户信息和权限数据
 * - updateUserInfos(): 更新用户信息
 * - getApiUserInfo(): 从API获取用户信息
 * - setPwdChangeCount(): 设置密码修改次数
 * 
 * 【计算属性的优势】
 * 1. 缓存机制：只有依赖的数据发生变化时才重新计算，避免不必要的运算
 * 2. 响应式更新：依赖数据变化时自动更新，无需手动触发
 * 3. 声明式：以声明的方式描述权限验证逻辑，代码更清晰
 */
const getUserAuthBtnList = computed(() => {
	// 权限验证算法：检查用户权限列表中是否包含所需权限
	
	// 获取用户的按钮权限列表（authBtnList）
	// 这是一个字符串数组，包含用户拥有的所有按钮权限标识符
	// 例如：['user:add', 'user:edit', 'role:view', 'system:config']
	const userPermissions = userInfos.value.authBtnList;
	
	// 获取组件要求的权限标识符
	const requiredPermission = props.value;
	
	// 使用Array.some()方法进行权限匹配
	// some()方法：测试数组中是否至少有一个元素通过测试函数
	// 优势：找到匹配项立即返回true，性能优于filter()或includes()
	// v: 数组中的每个权限项
	// v === props.value: 严格相等比较，确保权限标识符完全匹配
	return userPermissions.some((permission: string) => permission === requiredPermission);
	
	// 返回值说明：
	// true: 用户拥有所需权限，组件内容将被渲染
	// false: 用户没有所需权限，组件内容将被隐藏
});

/**
 * ====================================================================================================
 *                                        权限系统工作流程
 * ====================================================================================================
 * 
 * 1. 【用户登录】：用户登录成功后，后端返回用户信息和权限列表
 * 2. 【权限存储】：Actions中的setUserInfos()将权限数据存储到State
 * 3. 【组件使用】：权限控制组件通过props接收权限标识符
 * 4. 【权限验证】：计算属性getUserAuthBtnList检查用户是否拥有所需权限
 * 5. 【条件渲染】：模板根据权限验证结果决定是否渲染组件内容
 * 6. 【响应式更新】：当用户权限发生变化时，所有相关组件自动更新
 * 
 * ====================================================================================================
 */
</script>
